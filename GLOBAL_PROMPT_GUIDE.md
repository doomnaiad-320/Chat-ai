# 严格长度控制的全局提示词系统

## 🎯 功能概述

我们为你的iMessage AI聊天应用实现了一个**严格长度控制**的全局提示词系统，确保AI回复始终保持在合理长度内，同时具备口语化、生动和自然的特点。

## 🚨 核心特性：严格长度控制

### **四层保障机制**
1. **预防层**：严格的system prompt指令
2. **校验层**：回复后的自动检查和修正
3. **监控层**：违规统计和动态prompt调整
4. **强制层**：最终输出前的长度截断

## ✨ 严格长度控制标准

### **普通回复判定条件**
- ✅ **字符数**: ≤50个字符（包括标点和空格）
- ✅ **句子数**: ≤2句话
- ✅ **格式要求**: 不能有换行符和冒号
- ✅ **禁用词汇**: 不能包含"首先"、"第一"、"以下"、"然后"、"接下来"等长篇标志词

### **自动修正机制**
1. **长度超限**: 自动截断到50字符内
2. **句子过多**: 保留前2句，删除多余部分
3. **格式违规**: 移除换行符，将冒号替换为逗号
4. **关键词违规**: 自动删除长篇标志词

### **违规监控系统**
- 📊 **实时统计**: 记录各类违规次数
- 📈 **动态调整**: 根据违规情况自动强化提示词
- 🚨 **警告机制**: 违规达到阈值时强化约束
- 📋 **详细报告**: 提供完整的违规分析报告

## ✨ 口语化增强特性

### 1. **智能语气词**
- 在长度限制内添加"呢"、"呀"、"啦"等语气词
- 根据角色性格调整语气风格
- 支持可爱、温柔、严肃、幽默、活泼等不同风格

### 2. **表情符号**
- 在长度限制内添加合适的emoji
- 不同性格使用不同的表情集合
- 智能检测避免重复添加

### 3. **性格一致性**
- 基于角色的voiceStyle调整语气
- 保持角色设定的一致性
- 支持多角色不同风格

## 🚀 使用方法

### 访问设置
1. 打开应用：http://localhost:5173/
2. 进入"设置"页面
3. 找到"AI对话风格设置"部分

### 基础配置
- **使用表情符号**：开启后AI会自动添加emoji
- **使用语气词**：开启后AI会添加"呢"、"呀"等语气词
- **对话式风格**：开启后模仿真人聊天节奏
- **回复长度**：设置每次回复的最大句子数（1-5句）

### 全局提示词管理
系统内置了5个核心提示词：
1. **口语化对话风格** - 让AI使用自然的口语化方式
2. **表情符号增强** - 适当使用表情符号
3. **回复长度控制** - 严格控制回复长度
4. **性格一致性** - 保持角色设定一致
5. **自然对话节奏** - 模仿真人聊天节奏

## 🧪 测试示例

### 原始AI回复
```
你好，我很高兴认识你。今天天气很好。
```

### 不同风格处理后
- **可爱风格**：你好呀，我很高兴认识你呢。今天天气很好啦！😊
- **温柔风格**：你好，我很高兴认识你呢。今天天气很好。🌸
- **严肃风格**：你好，我很高兴认识你。今天天气很好。
- **幽默风格**：嘿，你好，我很高兴认识你呀。今天天气很好哈哈！😄
- **活泼风格**：你好呀，我很高兴认识你！今天天气很好啦！🌟

## 🎨 高级功能

### AI回复拆分
支持特殊格式的AI回复拆分：
```
[角色名|普通消息]
<角色名|表情ID>
[角色名|语音|时长|内容]
{角色名|撤回消息}
【心声|角色名|内心想法】
「随笔|角色名|随笔内容」
```

### 示例拆分回复
```
[小助手|你好呀！我是你的AI助手呢]
<小助手|smile>
[小助手|很高兴为你服务啦！]
{小助手|其实我有点紧张...}
[小助手|有什么可以帮你的吗？]
【心声|小助手|希望能帮到用户】
```

## 🔧 技术实现

### 核心组件
- **GlobalPromptSettings**: 全局提示词管理界面
- **AIResponseProcessor**: AI回复后处理器
- **AIResponseSplitter**: AI回复拆分器
- **MessageDisplayController**: 消息显示控制器

### 配置文件
- **globalPrompts.ts**: 语气词和表情符号配置
- **aiResponseProcessor.ts**: 回复处理逻辑

### 数据流程
1. 用户发送消息
2. 系统构建包含全局提示词的系统提示
3. 调用AI API获取回复
4. AI回复处理器添加口语化元素
5. 检查是否需要拆分显示
6. 逐条显示消息，模拟真人聊天节奏

## 📱 移动端优化

### 交互改进
- 移除悬停效果，改为直接显示操作按钮
- 优化触摸反馈，添加点击缩放效果
- 适配移动端的操作习惯

### 按钮布局
- 编辑按钮：蓝色圆形，铅笔图标
- 删除按钮：红色圆形，垃圾桶图标
- 直接显示在角色卡片右侧

## 🎯 最佳实践

### 角色设置建议
1. **可爱型角色**：多用"呢"、"呀"、"啦"，配合😊🥰等表情
2. **温柔型角色**：语气温和，多用"哦"、"呢"，配合🌸💫等表情
3. **严肃型角色**：语气正式，少用语气词，配合🤔😐等表情
4. **幽默型角色**：可以开玩笑，用"哈哈"、"嘿嘿"，配合😄🤣等表情
5. **活泼型角色**：语气活跃，多用感叹号，配合🎉⚡等表情

### 提示词优化
- 按优先级排序，重要的提示词设置更高优先级
- 避免提示词之间的冲突
- 定期测试不同组合的效果

## 🚨 注意事项

1. **性能考虑**：过多的全局提示词可能影响API响应速度
2. **成本控制**：更长的提示词会增加API调用成本
3. **效果平衡**：过度的口语化可能影响信息传达的准确性
4. **角色一致性**：确保全局提示词与角色设定不冲突

## 🎉 开始使用

现在你可以：
1. 访问 http://localhost:5173/
2. 进入设置页面配置AI对话风格
3. 创建或编辑角色，设置不同的voiceStyle
4. 开始聊天，体验更自然的AI对话！

享受更生动、更真实的AI聊天体验吧！🎊
